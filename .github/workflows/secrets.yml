name: Secrets Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  # ============================================================================
  # TruffleHog Secrets Scan
  # ============================================================================
  trufflehog:
    name: TruffleHog Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  # ============================================================================
  # GitLeaks Scan
  # ============================================================================
  gitleaks:
    name: GitLeaks Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run GitLeaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # ============================================================================
  # GitGuardian Scan
  # ============================================================================
  gitguardian:
    name: GitGuardian Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: GitGuardian Scan
        uses: GitGuardian/ggshield-action@v1.32.0
        env:
          GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
          GITHUB_PULL_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

  # ============================================================================
  # Detect Secrets (Yelp)
  # ============================================================================
  detect-secrets:
    name: Detect Secrets (Yelp)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Scan for secrets
        run: detect-secrets scan --all-files --force-use-all-plugins

  # ============================================================================
  # Custom Patterns Scan
  # ============================================================================
  custom-patterns:
    name: Custom Secret Patterns
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Scan for API keys and secrets
        run: |
          echo "Scanning for common secret patterns..."
          
          # Define patterns to check
          patterns=(
            'sk_live_[a-zA-Z0-9]{32,}'
            'sk_test_[a-zA-Z0-9]{32,}'
            'pk_live_[a-zA-Z0-9]{32,}'
            'pk_test_[a-zA-Z0-9]{32,}'
            'AKIA[0-9A-Z]{16}'
            'ghp_[a-zA-Z0-9]{36}'
            'glpat-[a-zA-Z0-9\-]{20}'
            ' PRIVATE KEY'
            'apikey[[:space:]]*=[[:space:]]*["'\''"'\'''][^"'\''"'\''']{20,}'
            'password[[:space:]]*=[[:space:]]*["'\''"'\'''][^"'\''"'\''']{8,}'
          )
          
          found=0
          for pattern in "${patterns[@]}"; do
            echo "Checking pattern: $pattern"
            matches=$(grep -r -E "$pattern" --include="*.ts" --include="*.js" --include="*.json" --include="*.yml" --include="*.yaml" --include="*.env*" . 2>/dev/null || true)
            if [ -n "$matches" ]; then
              echo "POTENTIAL SECRET FOUND:"
              echo "$matches"
              found=1
            fi
          done
          
          if [ $found -eq 1 ]; then
            echo "❌ Potential secrets found in code!"
            exit 1
          else
            echo "✅ No obvious secrets detected"
          fi

      - name: Check for .env files
        run: |
          if find . -name ".env*" -type f | grep -q .; then
            echo "⚠️  Warning: .env files found in repository:"
            find . -name ".env*" -type f
            echo "Make sure these are not committed with real secrets!"
          else
            echo "✅ No .env files found"
          fi

      - name: Check for TODO/FIXME with secrets
        run: |
          if grep -r -i "TODO.*secret\|FIXME.*key\|HACK.*password" --include="*.ts" --include="*.js" . 2>/dev/null; then
            echo "⚠️  Warning: Found TODO/FIXME comments mentioning secrets"
          fi
